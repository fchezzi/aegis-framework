<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
	<meta charset="utf-8"/>
</head>
<body>

<h1 id="padr√£o:acessop√∫blicoprivadoemm√≥dulos">Padr√£o: Acesso P√∫blico/Privado em M√≥dulos</h1>

<h2 id="‚ö†Ô∏èobrigat√ìrioparatodososnovosm√ìdulos">‚ö†Ô∏è OBRIGAT√ìRIO PARA TODOS OS NOVOS M√ìDULOS</h2>

<p>Este padr√£o √© <strong>OBRIGAT√ìRIO</strong> para todos os m√≥dulos que possuem rotas p√∫blicas. N√£o √© opcional.</p>

<h2 id="üö®regracr√çtica:prefixoobrigat√≥rionasrotasp√∫blicas">üö® REGRA CR√çTICA: Prefixo Obrigat√≥rio nas Rotas P√∫blicas</h2>

<p><strong>TODOS os m√≥dulos (exceto Blog) DEVEM usar prefixo <code>/{nome_modulo}/</code> em TODAS as rotas p√∫blicas.</strong></p>

<h3 id="‚úÖcorreto:">‚úÖ Correto:</h3>

<ul>
<li><code>/palpites/exibicao-palpites</code></li>
<li><code>/cursos/aula-01</code></li>
<li><code>/loja/produtos</code></li>
<li><code>/forum/topico-123</code></li>
</ul>

<h3 id="‚ùåerrado:">‚ùå ERRADO:</h3>

<ul>
<li><code>/exibicao-palpites</code> (sem prefixo)</li>
<li><code>/aula-01</code> (sem prefixo)</li>
<li><code>/produtos</code> (sem prefixo)</li>
</ul>

<h3 id="üéØexce√ß√£o:blog">üéØ Exce√ß√£o: Blog</h3>

<p>O m√≥dulo <strong>blog</strong> √© a √öNICA exce√ß√£o devido a requisitos de SEO:</p>

<ul>
<li><code>/:categoria</code> (permitido)</li>
<li><code>/:categoria/:post</code> (permitido)</li>
<li><code>/blog</code> (rota base)</li>
</ul>

<p><strong>Por qu√™ essa regra?</strong></p>

<ul>
<li>Evita conflitos entre m√≥dulos</li>
<li>Evita conflitos com p√°ginas do AEGIS</li>
<li>Escal√°vel (suporta infinitos m√≥dulos)</li>
<li>Simples de validar</li>
</ul>

<h2 id="‚ö†Ô∏èregracr√çticaatualizada2025-11-24">‚ö†Ô∏è REGRA CR√çTICA (Atualizada 2025&#8211;11&#8211;24)</h2>

<p><strong>M√ìDULOS N√ÉO PRECISAM DE P√ÅGINAS NA TABELA <code>pages</code>!</strong></p>

<h3 id="controledeacessoportipo:">Controle de Acesso por Tipo:</h3>

<table>
<colgroup>
<col />
<col />
<col />
</colgroup>

<thead>
<tr>
	<th> Tipo </th>
	<th> Fonte de Verdade </th>
	<th> Onde Configurar </th>
</tr>
</thead>

<tbody>
<tr>
	<td> <strong>M√≥dulo</strong> </td>
	<td> <code>&quot;public&quot;</code> no <code>module.json</code> </td>
	<td> <code>/admin/modules</code> (Gerenciar M√≥dulos) </td>
</tr>
<tr>
	<td> <strong>P√°gina</strong> </td>
	<td> <code>is_public</code> na tabela <code>pages</code> </td>
	<td> <code>/admin/pages</code> </td>
</tr>
</tbody>
</table>

<p><strong>Separa√ß√£o clara:</strong></p>

<ul>
<li>M√≥dulos = <code>module.json</code></li>
<li>P√°ginas = tabela <code>pages</code></li>
</ul>

<hr />

<h2 id="objetivo">Objetivo</h2>

<p>Permitir que m√≥dulos tenham rotas p√∫blicas que respeitam o campo <code>&quot;public&quot;</code> do <code>module.json</code>, com controle visual no admin &#8220;Gerenciar M√≥dulos&#8221;.</p>

<h2 id="funcionamento">Funcionamento</h2>

<h3 id="1.configura√ß√£onomodule.json">1. Configura√ß√£o no <code>module.json</code></h3>

<pre><code class="json">{
  &quot;name&quot;: &quot;nome_modulo&quot;,
  &quot;label&quot;: &quot;Nome do M√≥dulo&quot;,
  &quot;public&quot;: false,
  &quot;public_url&quot;: &quot;/caminho-publico&quot;
}
</code></pre>

<ul>
<li><code>public</code>: Define se m√≥dulo √© p√∫blico por padr√£o (geralmente <code>false</code>)</li>
<li><code>public_url</code>: URL p√∫blica principal do m√≥dulo</li>
</ul>

<h3 id="2.fun√ß√£ohelpernoroutes.php">2. Fun√ß√£o Helper no <code>routes.php</code></h3>

<p>Adicionar no <strong>in√≠cio</strong> do arquivo de rotas do m√≥dulo:</p>

<pre><code class="php">// =========================================
// HELPER: Verificar se m√≥dulo √© p√∫blico
// =========================================
function checkModuleAccess($pageSlug) {
    // Se MEMBERS desabilitado, libera acesso
    if (!ENABLE_MEMBERS) {
        return true;
    }

    // Buscar p√°gina no banco de dados
    $db = DB::connect();
    $pages = $db-&gt;select('pages', ['slug' =&gt; $pageSlug, 'ativo' =&gt; 1]);

    if (empty($pages)) {
        // P√°gina n√£o existe - libera acesso (m√≥dulo p√∫blico por padr√£o)
        return true;
    }

    $page = $pages[0];

    // Se m√≥dulo √© p√∫blico (is_public = 1), libera acesso sem login
    if (($page['is_public'] ?? 0) == 1) {
        return true;
    }

    // M√≥dulo privado - exige autentica√ß√£o e permiss√£o
    MemberAuth::require();
    $member = MemberAuth::member();

    if (!Permission::canAccess($member['id'], $page['id'])) {
        http_response_code(403);
        echo &quot;&lt;!DOCTYPE html&gt;&quot;;
        echo &quot;&lt;html lang='pt-BR'&gt;&lt;head&gt;&lt;meta charset='UTF-8'&gt;&quot;;
        echo &quot;&lt;title&gt;Acesso Negado&lt;/title&gt;&quot;;
        echo &quot;&lt;style&gt;body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;&quot;;
        echo &quot;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;&quot;;
        echo &quot;background:#f5f5f5;text-align:center;}&quot;;
        echo &quot;h1{font-size:48px;color:#ef4444;margin-bottom:10px;}&quot;;
        echo &quot;p{color:#666;margin-bottom:20px;}&quot;;
        echo &quot;a{color:#667eea;text-decoration:none;}&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&quot;;
        echo &quot;&lt;div&gt;&lt;h1&gt;üîí Acesso Negado&lt;/h1&gt;&quot;;
        echo &quot;&lt;p&gt;Voc√™ n√£o tem permiss√£o para acessar esta p√°gina.&lt;/p&gt;&quot;;
        echo &quot;&lt;a href='&quot; . url('/home') . &quot;'&gt;‚Üê Voltar para Home&lt;/a&gt;&lt;/div&gt;&quot;;
        echo &quot;&lt;/body&gt;&lt;/html&gt;&quot;;
        exit;
    }

    return true;
}
</code></pre>

<h3 id="3.aplicarnasrotasp√∫blicas">3. Aplicar nas Rotas P√∫blicas</h3>

<p>Adicionar <code>checkModuleAccess()</code> no <strong>in√≠cio</strong> de cada rota p√∫blica:</p>

<pre><code class="php">// =========================================
// ROTAS P√öBLICAS
// =========================================

Router::get('/blog', function() {
    checkModuleAccess('module_blog');
    require_once __DIR__ . '/controllers/PublicBlogController.php';
    $controller = new PublicBlogController();
    $controller-&gt;index();
});

Router::get('/palpites/exibicao', function() {
    checkModuleAccess('palpites/exibicao-palpites');
    require_once __DIR__ . '/views/public/exibicao-palpites.php';
});
</code></pre>

<h3 id="4.slugdap√°gina">4. Slug da P√°gina</h3>

<p>O <code>$pageSlug</code> passado para <code>checkModuleAccess()</code> deve corresponder ao campo <code>slug</code> na tabela <code>pages</code>:</p>

<ul>
<li><strong>Conven√ß√£o para m√≥dulos:</strong> <code>module_{nome_modulo}</code> (ex: <code>module_blog</code>)</li>
<li><strong>Conven√ß√£o para p√°ginas espec√≠ficas:</strong> <code>{modulo}/{pagina}</code> (ex: <code>palpites/exibicao-palpites</code>)</li>
</ul>

<h2 id="comportamento">Comportamento</h2>

<h3 id="quandoenable_membersfalsesemsistemademembros">Quando <code>ENABLE_MEMBERS = false</code> (sem sistema de membros)</h3>

<ul>
<li><strong>Todas as rotas p√∫blicas s√£o liberadas automaticamente</strong></li>
<li>N√£o verifica permiss√µes</li>
<li>Acesso totalmente p√∫blico</li>
</ul>

<h3 id="quandoenable_memberstruecomsistemademembros">Quando <code>ENABLE_MEMBERS = true</code> (com sistema de membros)</h3>

<h4 id="sepublic:truenomodule.json:">Se <code>&quot;public&quot;: true</code> no module.json:</h4>

<ul>
<li><strong>Acesso liberado sem login</strong></li>
<li>Qualquer pessoa pode acessar</li>
<li>Menu aparece para todos</li>
<li>Ideal para conte√∫do p√∫blico (blog, landing pages)</li>
</ul>

<h4 id="sepublic:falsenomodule.json:">Se <code>&quot;public&quot;: false</code> no module.json:</h4>

<ul>
<li><strong>Exige login (MemberAuth::require())</strong></li>
<li>Menu s√≥ aparece para usu√°rios autenticados</li>
<li>Acesso controlado por autentica√ß√£o</li>
</ul>

<h2 id="vantagens">Vantagens</h2>

<ol>
<li><strong>Uma fonte de verdade:</strong> M√≥dulos controlados APENAS por <code>module.json</code></li>
<li><strong>Controle visual:</strong> Admin muda <code>public</code> via interface &#8220;Gerenciar M√≥dulos&#8221;</li>
<li><strong>Sem duplica√ß√£o:</strong> N√£o precisa criar p√°ginas no banco para m√≥dulos</li>
<li><strong>Separa√ß√£o clara:</strong> M√≥dulos ‚â† P√°ginas (conceitos diferentes)</li>
<li><strong>Compatibilidade:</strong> Funciona com e sem sistema de membros</li>
<li><strong>Padr√£o consistente:</strong> Todos os m√≥dulos seguem mesma l√≥gica</li>
</ol>

<h2 id="exemplosdeuso">Exemplos de Uso</h2>

<h3 id="blogsemprep√∫blico">Blog sempre p√∫blico</h3>

<pre><code class="json">// modules/blog/module.json
{
  &quot;public&quot;: true
}
</code></pre>

<p>‚Üí Menu aparece para todos, rotas acess√≠veis sem login</p>

<h3 id="palpitesapenasparamembrosautenticados">Palpites apenas para membros autenticados</h3>

<pre><code class="json">// modules/palpites/module.json
{
  &quot;public&quot;: false
}
</code></pre>

<p>‚Üí Menu s√≥ aparece logado, rotas exigem autentica√ß√£o</p>

<h3 id="controlefinoviacheckmoduleaccess">Controle fino via checkModuleAccess()</h3>

<p>Para controle mais granular (por grupo/membro), usar l√≥gica dentro do <code>checkModuleAccess()</code> nas rotas do m√≥dulo.</p>

<h2 id="checklistobrigat√ìrioparanovosm√≥dulos">Checklist OBRIGAT√ìRIO para Novos M√≥dulos</h2>

<p><strong>Ao criar qualquer m√≥dulo novo, seguir OBRIGATORIAMENTE:</strong></p>

<h3 id="1Ô∏è‚É£configura√ß√£odomodule.json">1Ô∏è‚É£ Configura√ß√£o do module.json</h3>

<ul>
<li>[ ] ‚úÖ Adicionar <code>&quot;label&quot;</code>: &#8220;Nome do M√≥dulo&#8221; (para exibi√ß√£o no menu)</li>
<li>[ ] ‚úÖ Adicionar <code>&quot;public&quot;: false</code> (m√≥dulos privados por padr√£o)</li>
<li>[ ] ‚úÖ Adicionar <code>&quot;public_url&quot;</code>: &#8220;/modulo/rota-principal&#8221;</li>
<li>[ ] ‚úÖ Adicionar <code>&quot;icon&quot;</code>: &#8220;nome-do-icone&#8221; (Lucide icons)</li>
</ul>

<h3 id="2Ô∏è‚É£rotasp√∫blicas">2Ô∏è‚É£ Rotas P√∫blicas</h3>

<ul>
<li>[ ] ‚úÖ <strong>PREFIXO OBRIGAT√ìRIO:</strong> Todas as rotas p√∫blicas DEVEM come√ßar com <code>/{nome_modulo}/</code></li>
<li>[ ] ‚úÖ Copiar fun√ß√£o <code>checkModuleAccess()</code> no in√≠cio do <code>routes.php</code></li>
<li>[ ] ‚úÖ Aplicar <code>checkModuleAccess('{nome_modulo}')</code> em TODAS as rotas p√∫blicas</li>
<li>[ ] ‚úÖ Passar o <strong>nome do m√≥dulo</strong> (ex: <code>'blog'</code>), N√ÉO o slug da p√°gina</li>
</ul>

<h3 id="3Ô∏è‚É£testescr√çtico">3Ô∏è‚É£ Testes (CR√çTICO)</h3>

<ul>
<li>[ ] ‚úÖ Testar com <code>ENABLE_MEMBERS = false</code> (deve funcionar p√∫blico)</li>
<li>[ ] ‚úÖ Testar com <code>ENABLE_MEMBERS = true</code> e <code>public: false</code> (deve exigir login)</li>
<li>[ ] ‚úÖ Testar com <code>ENABLE_MEMBERS = true</code> e <code>public: true</code> (deve funcionar p√∫blico)</li>
<li>[ ] ‚úÖ <strong>Instalar OUTRO m√≥dulo</strong> e testar novamente (validar que n√£o quebra com m√∫ltiplos m√≥dulos)</li>
<li>[ ] ‚úÖ Fazer logout e verificar se menu aparece/desaparece corretamente</li>
</ul>

<h3 id="4Ô∏è‚É£valida√ß√µesfinais">4Ô∏è‚É£ Valida√ß√µes Finais</h3>

<ul>
<li>[ ] ‚úÖ <strong>N√ÉO criar p√°ginas na tabela <code>pages</code></strong> - m√≥dulos n√£o precisam!</li>
<li>[ ] ‚úÖ Verificar que ModuleManager.php N√ÉO cria p√°ginas ao instalar</li>
<li>[ ] ‚úÖ Menu item criado com <code>page_slug: null</code> e <code>type: 'module'</code></li>
<li>[ ] ‚úÖ Controle de acesso: APENAS via <code>&quot;public&quot;</code> no <code>module.json</code></li>
</ul>

<p><strong>Notas Importantes:</strong></p>

<ul>
<li>‚ö†Ô∏è <strong>M√ìDULOS ‚â† P√ÅGINAS</strong> - Nunca misturar os dois conceitos</li>
<li>‚úÖ Configura√ß√£o visual: <code>/admin/modules</code> (Gerenciar M√≥dulos)</li>
<li>‚úÖ Se deletar p√°ginas antigas do m√≥dulo, atualizar TODAS as rotas que referenciam elas</li>
<li><strong>EXCE√á√ÉO:</strong> Apenas o m√≥dulo <code>blog</code> pode ter rotas sem prefixo (devido a SEO)</li>
</ul>

<h2 id="m√≥dulosqueseguemestepadr√£o">M√≥dulos que Seguem Este Padr√£o</h2>

<ul>
<li>‚úÖ <code>palpites</code> - Refer√™ncia original</li>
<li>‚úÖ <code>blog</code> - Implementado</li>
</ul>

</body>
</html>

