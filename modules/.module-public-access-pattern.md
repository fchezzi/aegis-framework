# Padr√£o: Acesso P√∫blico/Privado em M√≥dulos

## ‚ö†Ô∏è OBRIGAT√ìRIO PARA TODOS OS NOVOS M√ìDULOS

Este padr√£o √© **OBRIGAT√ìRIO** para todos os m√≥dulos que possuem rotas p√∫blicas. N√£o √© opcional.

## üö® REGRA CR√çTICA: Prefixo Obrigat√≥rio nas Rotas P√∫blicas

**TODOS os m√≥dulos (exceto Blog) DEVEM usar prefixo `/{nome_modulo}/` em TODAS as rotas p√∫blicas.**

### ‚úÖ Correto:
- `/palpites/exibicao-palpites`
- `/cursos/aula-01`
- `/loja/produtos`
- `/forum/topico-123`

### ‚ùå ERRADO:
- `/exibicao-palpites` (sem prefixo)
- `/aula-01` (sem prefixo)
- `/produtos` (sem prefixo)

### üéØ Exce√ß√£o: Blog
O m√≥dulo **blog** √© a √öNICA exce√ß√£o devido a requisitos de SEO:
- `/:categoria` (permitido)
- `/:categoria/:post` (permitido)
- `/blog` (rota base)

**Por qu√™ essa regra?**
- Evita conflitos entre m√≥dulos
- Evita conflitos com p√°ginas do AEGIS
- Escal√°vel (suporta infinitos m√≥dulos)
- Simples de validar

## ‚ö†Ô∏è REGRA CR√çTICA (Atualizada 2025-11-24)

**M√ìDULOS N√ÉO PRECISAM DE P√ÅGINAS NA TABELA `pages`!**

### Controle de Acesso por Tipo:

| Tipo | Fonte de Verdade | Onde Configurar |
|------|------------------|-----------------|
| **M√≥dulo** | `"public"` no `module.json` | `/admin/modules` (Gerenciar M√≥dulos) |
| **P√°gina** | `is_public` na tabela `pages` | `/admin/pages` |

**Separa√ß√£o clara:**
- M√≥dulos = `module.json`
- P√°ginas = tabela `pages`

---

## Objetivo
Permitir que m√≥dulos tenham rotas p√∫blicas que respeitam o campo `"public"` do `module.json`, com controle visual no admin "Gerenciar M√≥dulos".

## Funcionamento

### 1. Configura√ß√£o no `module.json`
```json
{
  "name": "nome_modulo",
  "label": "Nome do M√≥dulo",
  "public": false,
  "public_url": "/caminho-publico"
}
```

- `public`: Define se m√≥dulo √© p√∫blico por padr√£o (geralmente `false`)
- `public_url`: URL p√∫blica principal do m√≥dulo

### 2. Fun√ß√£o Helper no `routes.php`

Adicionar no **in√≠cio** do arquivo de rotas do m√≥dulo:

```php
// =========================================
// HELPER: Verificar se m√≥dulo √© p√∫blico
// =========================================
function checkModuleAccess($pageSlug) {
    // Se MEMBERS desabilitado, libera acesso
    if (!ENABLE_MEMBERS) {
        return true;
    }

    // Buscar p√°gina no banco de dados
    $db = DB::connect();
    $pages = $db->select('pages', ['slug' => $pageSlug, 'ativo' => 1]);

    if (empty($pages)) {
        // P√°gina n√£o existe - libera acesso (m√≥dulo p√∫blico por padr√£o)
        return true;
    }

    $page = $pages[0];

    // Se m√≥dulo √© p√∫blico (is_public = 1), libera acesso sem login
    if (($page['is_public'] ?? 0) == 1) {
        return true;
    }

    // M√≥dulo privado - exige autentica√ß√£o e permiss√£o
    MemberAuth::require();
    $member = MemberAuth::member();

    if (!Permission::canAccess($member['id'], $page['id'])) {
        http_response_code(403);
        echo "<!DOCTYPE html>";
        echo "<html lang='pt-BR'><head><meta charset='UTF-8'>";
        echo "<title>Acesso Negado</title>";
        echo "<style>body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;";
        echo "display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;";
        echo "background:#f5f5f5;text-align:center;}";
        echo "h1{font-size:48px;color:#ef4444;margin-bottom:10px;}";
        echo "p{color:#666;margin-bottom:20px;}";
        echo "a{color:#667eea;text-decoration:none;}</style></head><body>";
        echo "<div><h1>üîí Acesso Negado</h1>";
        echo "<p>Voc√™ n√£o tem permiss√£o para acessar esta p√°gina.</p>";
        echo "<a href='" . url('/home') . "'>‚Üê Voltar para Home</a></div>";
        echo "</body></html>";
        exit;
    }

    return true;
}
```

### 3. Aplicar nas Rotas P√∫blicas

Adicionar `checkModuleAccess()` no **in√≠cio** de cada rota p√∫blica:

```php
// =========================================
// ROTAS P√öBLICAS
// =========================================

Router::get('/blog', function() {
    checkModuleAccess('module_blog');
    require_once __DIR__ . '/controllers/PublicBlogController.php';
    $controller = new PublicBlogController();
    $controller->index();
});

Router::get('/palpites/exibicao', function() {
    checkModuleAccess('palpites/exibicao-palpites');
    require_once __DIR__ . '/views/public/exibicao-palpites.php';
});
```

### 4. Slug da P√°gina

O `$pageSlug` passado para `checkModuleAccess()` deve corresponder ao campo `slug` na tabela `pages`:

- **Conven√ß√£o para m√≥dulos:** `module_{nome_modulo}` (ex: `module_blog`)
- **Conven√ß√£o para p√°ginas espec√≠ficas:** `{modulo}/{pagina}` (ex: `palpites/exibicao-palpites`)

## Comportamento

### Quando `ENABLE_MEMBERS = false` (sem sistema de membros)
- **Todas as rotas p√∫blicas s√£o liberadas automaticamente**
- N√£o verifica permiss√µes
- Acesso totalmente p√∫blico

### Quando `ENABLE_MEMBERS = true` (com sistema de membros)

#### Se `"public": true` no module.json:
- **Acesso liberado sem login**
- Qualquer pessoa pode acessar
- Menu aparece para todos
- Ideal para conte√∫do p√∫blico (blog, landing pages)

#### Se `"public": false` no module.json:
- **Exige login (MemberAuth::require())**
- Menu s√≥ aparece para usu√°rios autenticados
- Acesso controlado por autentica√ß√£o

## Vantagens

1. **Uma fonte de verdade:** M√≥dulos controlados APENAS por `module.json`
2. **Controle visual:** Admin muda `public` via interface "Gerenciar M√≥dulos"
3. **Sem duplica√ß√£o:** N√£o precisa criar p√°ginas no banco para m√≥dulos
4. **Separa√ß√£o clara:** M√≥dulos ‚â† P√°ginas (conceitos diferentes)
5. **Compatibilidade:** Funciona com e sem sistema de membros
6. **Padr√£o consistente:** Todos os m√≥dulos seguem mesma l√≥gica

## Exemplos de Uso

### Blog sempre p√∫blico
```json
// modules/blog/module.json
{
  "public": true
}
```
‚Üí Menu aparece para todos, rotas acess√≠veis sem login

### Palpites apenas para membros autenticados
```json
// modules/palpites/module.json
{
  "public": false
}
```
‚Üí Menu s√≥ aparece logado, rotas exigem autentica√ß√£o

### Controle fino via checkModuleAccess()
Para controle mais granular (por grupo/membro), usar l√≥gica dentro do `checkModuleAccess()` nas rotas do m√≥dulo.

## Checklist OBRIGAT√ìRIO para Novos M√≥dulos

**Ao criar qualquer m√≥dulo novo, seguir OBRIGATORIAMENTE:**

### 1Ô∏è‚É£ Configura√ß√£o do module.json
- [ ] ‚úÖ Adicionar `"label"`: "Nome do M√≥dulo" (para exibi√ß√£o no menu)
- [ ] ‚úÖ Adicionar `"public": false` (m√≥dulos privados por padr√£o)
- [ ] ‚úÖ Adicionar `"public_url"`: "/modulo/rota-principal"
- [ ] ‚úÖ Adicionar `"icon"`: "nome-do-icone" (Lucide icons)

### 2Ô∏è‚É£ Rotas P√∫blicas
- [ ] ‚úÖ **PREFIXO OBRIGAT√ìRIO:** Todas as rotas p√∫blicas DEVEM come√ßar com `/{nome_modulo}/`
- [ ] ‚úÖ Copiar fun√ß√£o `checkModuleAccess()` no in√≠cio do `routes.php`
- [ ] ‚úÖ Aplicar `checkModuleAccess('{nome_modulo}')` em TODAS as rotas p√∫blicas
- [ ] ‚úÖ Passar o **nome do m√≥dulo** (ex: `'blog'`), N√ÉO o slug da p√°gina

### 3Ô∏è‚É£ Testes (CR√çTICO)
- [ ] ‚úÖ Testar com `ENABLE_MEMBERS = false` (deve funcionar p√∫blico)
- [ ] ‚úÖ Testar com `ENABLE_MEMBERS = true` e `public: false` (deve exigir login)
- [ ] ‚úÖ Testar com `ENABLE_MEMBERS = true` e `public: true` (deve funcionar p√∫blico)
- [ ] ‚úÖ **Instalar OUTRO m√≥dulo** e testar novamente (validar que n√£o quebra com m√∫ltiplos m√≥dulos)
- [ ] ‚úÖ Fazer logout e verificar se menu aparece/desaparece corretamente

### 4Ô∏è‚É£ Valida√ß√µes Finais
- [ ] ‚úÖ **N√ÉO criar p√°ginas na tabela `pages`** - m√≥dulos n√£o precisam!
- [ ] ‚úÖ Verificar que ModuleManager.php N√ÉO cria p√°ginas ao instalar
- [ ] ‚úÖ Menu item criado com `page_slug: null` e `type: 'module'`
- [ ] ‚úÖ Controle de acesso: APENAS via `"public"` no `module.json`

**Notas Importantes:**
- ‚ö†Ô∏è **M√ìDULOS ‚â† P√ÅGINAS** - Nunca misturar os dois conceitos
- ‚úÖ Configura√ß√£o visual: `/admin/modules` (Gerenciar M√≥dulos)
- ‚úÖ Se deletar p√°ginas antigas do m√≥dulo, atualizar TODAS as rotas que referenciam elas
- **EXCE√á√ÉO:** Apenas o m√≥dulo `blog` pode ter rotas sem prefixo (devido a SEO)

## M√≥dulos que Seguem Este Padr√£o

- ‚úÖ `palpites` - Refer√™ncia original
- ‚úÖ `blog` - Implementado
