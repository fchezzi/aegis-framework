document.addEventListener("DOMContentLoaded",(function(){document.addEventListener("aegisFilterApplied",(function(e){console.log("ğŸ” Filtro aplicado - atualizando MetricCards:",e.detail);const t=e.detail.filterGroup,a=e.detail.filters,r=e.detail.config,o=document.querySelectorAll(`.metric-card[data-filter-group="${t}"]`);0!==o.length?o.forEach((e=>{console.log("ğŸ”„ Recarregando card:",e.id,"com filtros:",a,"config:",r),function(e,t={}){const a=e.dataset.apiUrl,r=e.dataset.table,o=e.dataset.column,c=e.dataset.operation,n=e.dataset.format,d=e.dataset.comparePeriod,i=e.dataset.dateField;if(!(a&&r&&o&&c))return void console.error("Card sem configuraÃ§Ã£o completa:",e.id,e.dataset);const s=t.filters||{},l=t.config||{},u=new URLSearchParams({table:r,column:o,operation:c,format:n||"number",compare_period:d||"yes"});i&&u.set("date_field",i),s.select&&l.value_field&&(u.set("value_field",l.value_field),u.set("select",s.select)),s.date_start&&u.set("date_start",s.date_start),s.date_end&&u.set("date_end",s.date_end);const _=e.querySelector(".metric-card__title p"),m=e.querySelector(".metric-card__value p");_&&(_.textContent,_.style.opacity="0.5",_.textContent="...");console.log("ğŸ” Carregando:",a+"?"+u.toString()),fetch(a+"?"+u.toString()).then((e=>{if(!e.ok)throw new Error("Erro HTTP: "+e.status);return e.json()})).then((t=>{if(console.log("ğŸ“¦ Resposta da API:",t),!t.success)throw new Error(t.error||"Erro desconhecido");if(_&&(_.style.opacity="1",_.textContent=t.current_formatted),m&&null!==t.percent_change){const e=t.percent_change>=0,a=e?"+ ":"- ";m.classList.remove("metric-card__value--positive","metric-card__value--negative"),m.classList.add(e?"metric-card__value--positive":"metric-card__value--negative"),m.textContent=a+Math.abs(Math.round(t.percent_change))+"%"}else m&&(m.textContent="-",m.classList.remove("metric-card__value--positive","metric-card__value--negative"));console.log("âœ… Card atualizado:",e.id,t.current_formatted);const a=new CustomEvent("aegisMetricCardReloaded",{detail:{cardId:e.id,value:t.current,percentChange:t.percent_change}});document.dispatchEvent(a)})).catch((e=>{console.error("âŒ Erro ao recarregar card:",e),console.error("âŒ Detalhes:",e.message,e.stack),_&&(_.style.opacity="1",_.textContent="Erro",_.style.color="red")}))}(e,{filters:a,config:r})})):console.warn("Nenhum MetricCard encontrado para o grupo:",t)})),console.log("âœ… AEGIS MetricCards inicializado")}));