function aplicarFiltroCard(e,t){const a=e.dataset.apiUrl,o=e.dataset.cardType||"metrica",r=e.dataset.operation,n=e.dataset.format||"number",c=e.dataset.comparePeriod||"no",i=t.select||"",d=t.date_start||"",l=t.date_end||"";let s=a+"?operation="+r+"&format="+n+"&compare_period="+c;if("metrica_multi_table"===o){for(let t=1;t<=10;t++){const a=e.getAttribute("data-source-"+t+"-table"),o=e.getAttribute("data-source-"+t+"-column"),r=e.getAttribute("data-source-"+t+"-date-field");a&&(s+="&source_"+t+"_table="+encodeURIComponent(a)),o&&(s+="&source_"+t+"_column="+encodeURIComponent(o)),r&&(s+="&source_"+t+"_date_field="+encodeURIComponent(r))}d&&(s+="&date_start="+d),l&&(s+="&date_end="+l)}else{const t=e.dataset.table,a=e.dataset.column,o=e.dataset.dateField||"",r=e.dataset.filterValueField||"",n=e.dataset.conditionColumn||"",c=e.dataset.conditionOperator||"",u=e.dataset.conditionValue||"";s+="&table="+t+"&column="+a,n&&u&&(s+="&condition_column="+encodeURIComponent(n),s+="&condition_operator="+encodeURIComponent(c),s+="&condition_value="+encodeURIComponent(u)),i&&r&&(s+="&value_field="+r+"&select="+i),o&&d&&(s+="&date_field="+o+"&date_start="+d),o&&l&&(s+="&date_end="+l)}let u=e.querySelector(".metric-card__title p");u||(u=e.querySelector(".metric-card__value")),u&&(u.textContent="...",fetch(s).then((function(e){return e.text()})).then((function(t){let a;try{a=JSON.parse(t)}catch(e){return void(u.textContent="Erro JSON")}if(a.success){u.textContent=a.current_formatted;let t=e.querySelector(".metric-card__change");if(t||(t=e.querySelector(".metric-card__value p")),t&&null!==a.percent_change&&void 0!==a.percent_change){const e=a.percent_change>=0,o=e?"+ ":"- ",r=a.previous_formatted||"0";t.classList.remove("metric-card__value--positive","metric-card__value--negative"),t.classList.add(e?"metric-card__value--positive":"metric-card__value--negative"),t.textContent=o+Math.abs(Math.round(a.percent_change))+"% ("+r+")"}else t&&(t.textContent="-",t.classList.remove("metric-card__value--positive","metric-card__value--negative"))}else u.textContent="Erro"})).catch((function(e){u.textContent="Erro"})))}document.addEventListener("DOMContentLoaded",(function(){document.querySelectorAll(".metric-card[data-filter-group]").forEach((function(e){const t=e.dataset.filterGroup;document.addEventListener("aegisFilterApplied",(function(a){const o=a.detail;console.log("Card recebeu evento:",o.filterGroup,"esperava:",t),o.filterGroup===t&&(console.log("Card vai aplicar filtro:",o.filters),aplicarFiltroCard(e,o.filters))}))}))}));