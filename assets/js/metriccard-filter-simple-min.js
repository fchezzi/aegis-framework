document.addEventListener("aegisFilterApplied",(function(e){try{fetch("/aegis/api/log.php?msg=[FILTER] EVENTO RECEBIDO: "+JSON.stringify(e.detail));const t=e.detail.filterGroup,a=e.detail.filters.select||"",r=e.detail.filters.date_start||"",c=e.detail.filters.date_end||"";console.log("ðŸŽ¯ Filtro recebido:",{group:t,select:a,dateStart:r,dateEnd:c});const i=document.querySelectorAll(`.metric-card[data-filter-group="${t}"]`);if(fetch("/aegis/api/log.php?msg=[FILTER] Cards encontrados: "+i.length),0===i.length)return;i.forEach((e=>{fetch("/aegis/api/log.php?msg=[FILTER] Processando card: "+e.id);const t=e.dataset.cardType||"metrica",i=e.dataset.operation,o=e.dataset.format||"number",s=e.dataset.comparePeriod||"no";fetch("/aegis/api/log.php?msg=[FILTER] CardType="+t+" Operation="+i);let l=`/aegis/api/metriccard-data.php?operation=${i}&format=${o}&compare_period=${s}`;if("metrica_multi_table"===t)for(let t=1;t<=10;t++){const a=e.getAttribute(`data-source-${t}-table`),r=e.getAttribute(`data-source-${t}-column`),c=e.getAttribute(`data-source-${t}-date-field`);a&&(l+=`&source_${t}_table=${encodeURIComponent(a)}`),r&&(l+=`&source_${t}_column=${encodeURIComponent(r)}`),c&&(l+=`&source_${t}_date_field=${encodeURIComponent(c)}`)}else{const t=e.dataset.table,i=e.dataset.column,o=e.dataset.dateField||"",s=e.dataset.filterValueField||"";l+=`&table=${t}&column=${i}`,a&&s&&(l+=`&value_field=${s}&select=${a}`),o&&r&&(l+=`&date_field=${o}&date_start=${r}`),o&&c&&(l+=`&date_end=${c}`)}"metrica_multi_table"===t&&(r&&(l+=`&date_start=${r}`),c&&(l+=`&date_end=${c}`));let n=e.querySelector(".metric-card__value");n||(n=e.querySelector(".metric-card__title p")),n?(n.textContent="...",fetch("/aegis/api/log.php?msg=[FILTER] URL: "+l),fetch(l).then((e=>e.json())).then((t=>{if(fetch("/aegis/api/log.php?msg=[FILTER] Resposta: "+JSON.stringify(t)),t.debug){const a=e.querySelector("details pre");a&&(a.textContent=JSON.stringify(t.debug,null,2))}if(t.success){n.textContent=t.current_formatted;let a=e.querySelector(".metric-card__change");if(a||(a=e.querySelector(".metric-card__value p")),a&&null!==t.percent_change&&void 0!==t.percent_change){const e=t.percent_change>=0,r=e?"+ ":"- ",c=t.previous_formatted||"0";a.classList.remove("metric-card__value--positive","metric-card__value--negative"),a.classList.add(e?"metric-card__value--positive":"metric-card__value--negative"),a.textContent=r+Math.abs(Math.round(t.percent_change))+"% ("+c+")"}else a&&(a.textContent="-",a.classList.remove("metric-card__value--positive","metric-card__value--negative"))}else n.textContent="Erro"})).catch((e=>{fetch("/aegis/api/log.php?msg=[FILTER] ERRO FETCH: "+e.message),n.textContent="Erro"}))):fetch("/aegis/api/log.php?msg=[FILTER] ERRO: Elemento valor nao encontrado em "+e.id)}))}catch(e){fetch("/aegis/api/log.php?msg=[FILTER] ERRO GERAL: "+e.message+" | Stack: "+e.stack)}}));