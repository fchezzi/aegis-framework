# Contexto Sess√£o - 27/01/2026

**AEGIS Framework v14.0.7**
**Trabalho:** M√≥dulo Artigos + Email/RD Station + Admin Settings

---

## üéØ O QUE FOI FEITO

### 1. M√≥dulo Artigos (Migrado de v9.0.2)
‚úÖ **Migra√ß√£o completa** de bkp-instituto-atualli para AEGIS v14.0.7
- Sistema de artigos cient√≠ficos com captura de leads
- Admin CRUD completo: `/admin/artigos`
- Frontend p√∫blico: `/artigos` (listagem + p√°gina individual)
- Busca AJAX com filtro de ano
- Upload de imagem + PDF
- Banco: `tbl_artigos` + `tbl_artigos_leads` (UUID)
- Auto-install/uninstall via `module.json`

**Principais adapta√ß√µes v9 ‚Üí v14:**
- INT AUTO_INCREMENT ‚Üí VARCHAR(36) UUID
- `Core::generateUUID()` para todos os inserts
- `Upload::pdf()` ‚Üí `Upload::uploadFile()`
- module.json atualizado para formato v14
- Helper `checkModuleAccess()` adicionado em routes.php

### 2. Email System (PHPMailer)
‚úÖ **Integra√ß√£o completa** com solu√ß√£o EXATA do bkp
- Classe `Email` em `core/Email.php`
- PHPMailer em `vendor/phpmailer/`
- M√©todos: `send()`, `enviarArtigo()`, `template()`
- Suporte a anexos (PDF, etc)
- SMTP configur√°vel via admin

### 3. RD Station Marketing
‚úÖ **Integra√ß√£o completa** com solu√ß√£o EXATA do bkp
- Classe `RDStation` em `core/RDStation.php`
- API de convers√µes: https://api.rd.services/platform/conversions
- Autentica√ß√£o via token p√∫blico (query param)
- M√©todos: `enviarLead()`, `formatarTelefone()`
- Tags + custom fields autom√°ticos

### 4. Admin Settings
‚úÖ **Interface de configura√ß√£o** em `/admin/settings`
- **SMTP:** 7 campos (host, porta, usu√°rio, senha, from, encryption)
- **RD Station:** 2 campos (enabled, api_key)
- **Tema:** cores + fontes
- **TinyMCE:** API key
- Atualiza√ß√£o autom√°tica do `_config.php` com backup

**Controller:** `admin/controllers/SettingsController.php`
- M√©todo `updateConfigFile()` atualiza defines no _config.php
- Suporta: boolean, integer, string
- Valida√ß√µes completas (email, porta, hex colors)
- Backup autom√°tico antes de modificar

---

## üìÅ ARQUIVOS CRIADOS/MODIFICADOS

### Novos Arquivos
```
core/Email.php (214 linhas)
core/RDStation.php (178 linhas)
vendor/phpmailer/ (biblioteca completa)
vendor/composer/ (autoloader)
modules/artigos/ (estrutura completa)
modules/artigos/README.md (documenta√ß√£o)
docs/CHANGELOG-2026-01-27.md (changelog completo)
.claude/setup-novo-projeto.md (guia setup)
.claude/CONTEXT-2026-01-27.md (este arquivo)
```

### Arquivos Modificados
```
admin/views/settings.php (adicionadas se√ß√µes SMTP + RD)
admin/controllers/SettingsController.php (processamento config)
docs/_state.md (atualizado para 27/01)
.claude/INDEX.md (refer√™ncias atualizadas)
.claude/QUICK_REFERENCE.md (Email + RDStation adicionados)
.claude/modules.md (exemplo completo do m√≥dulo artigos)
```

---

## ‚öôÔ∏è CONFIGURA√á√ïES

### _config.php (Constantes Adicionadas)
```php
// SMTP Configuration (PHPMailer)
define('SMTP_HOST', 'smtp.gmail.com');
define('SMTP_PORT', 587);
define('SMTP_USERNAME', 'atualliarquivos@gmail.com');
define('SMTP_PASSWORD', 'fluqtbzrjsvxkrcf');
define('SMTP_FROM_EMAIL', 'atualliarquivos@gmail.com');
define('SMTP_FROM_NAME', 'Instituto Atualli');
define('SMTP_ENCRYPTION', 'tls');

// RD Station Configuration
define('RDSTATION_ENABLED', true);
define('RDSTATION_API_KEY', 'ec7ec89963b10f2f5139fad15c28fd72');

// Installed Modules
define('INSTALLED_MODULES', 'artigos,blog');
```

### Agora Configur√°vel Via Admin
‚úÖ Acesse `/admin/settings` para alterar SMTP e RD Station
‚úÖ N√£o precisa editar `_config.php` manualmente

---

## üöÄ COMO USAR EM NOVOS PROJETOS

### Setup Completo (15min)
1. **Instalar AEGIS** via `setup.php`
2. **Configurar Settings** em `/admin/settings`:
   - SMTP (obrigat√≥rio para email)
   - RD Station (opcional)
3. **Instalar M√≥dulos** em `/admin/modules`:
   - Clicar "Instalar" no m√≥dulo desejado
4. **Testar**:
   - Admin: `/admin/artigos`
   - P√∫blico: `/artigos`

### Usar Email em Qualquer Controller
```php
// Email simples
Email::send($to, 'Assunto', '<p>Corpo HTML</p>');

// Email com anexo
Email::send($to, 'Assunto', '<p>Corpo</p>', '/path/file.pdf', 'nome.pdf');

// Email de artigo (template pronto)
Email::enviarArtigo($to, $nome, $tituloArtigo, $pdfPath);
```

### Usar RD Station em Qualquer Controller
```php
RDStation::enviarLead(
    $email,
    $nome,
    $whatsapp,
    $contexto,           // ex: "Artigo sobre X"
    $identificador,      // ex: slug ou ID √∫nico
    $dadosAdicionais     // array opcional (tags, custom fields)
);
```

---

## üîß PADR√ïES ESTABELECIDOS

### UUID Sempre
```php
// Gerar UUID para novos registros
$id = Core::generateUUID();

$db->insert('tabela', [
    'id' => $id,
    // ... outros campos
]);
```

### Upload Gen√©rico
```php
// Usar Upload::uploadFile() para qualquer tipo
$path = Upload::uploadFile('campo_form', ['pdf', 'jpg', 'png'], 10485760);
```

### Valida√ß√£o Completa
```php
// Sempre validar inputs
Security::validateCSRF($_POST['csrf_token']);
$campo = Security::sanitize($_POST['campo'] ?? '');

if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
    // erro
}
```

### Helper checkModuleAccess
```php
// Em routes.php de m√≥dulos
Router::get('/meu-modulo', function() {
    checkModuleAccess('meu-modulo');
    // ... resto do c√≥digo
});
```

---

## üêõ PROBLEMAS RESOLVIDOS

### 1. Array to string conversion (500 Error)
**Causa:** module.json tinha `routes` section incompat√≠vel + cache em session
**Solu√ß√£o:**
1. Remover `routes` de module.json (usar apenas `adminRoute` e `menu`)
2. Deletar sessions PHP: `rm -f /Applications/MAMP/tmp/php/sess_*`

### 2. Upload::pdf() n√£o existe
**Causa:** v14 n√£o tem m√©todo `pdf()`, apenas `uploadFile()` e `image()`
**Solu√ß√£o:** Substituir todas chamadas por `Upload::uploadFile()`

### 3. Email/RDStation classes n√£o encontradas
**Causa:** Classes n√£o existiam no v14
**Solu√ß√£o:** Copiar EXATAMENTE do bkp-instituto-atualli (conforme pedido do usu√°rio)

### 4. Parse error em SettingsController
**Causa:** Regex mal escapado em preg_match
**Solu√ß√£o:** Simplificar l√≥gica de adicionar define em _config.php

---

## üìñ DOCUMENTA√á√ÉO ATUALIZADA

### Arquivos de Refer√™ncia
- **INDEX.md** - √≠ndice principal atualizado
- **QUICK_REFERENCE.md** - Email e RDStation adicionados (20 classes agora)
- **modules.md** - exemplo completo do m√≥dulo artigos
- **setup-novo-projeto.md** - guia completo de setup (novo)
- **CHANGELOG-2026-01-27.md** - changelog detalhado
- **modules/artigos/README.md** - doc espec√≠fica do m√≥dulo

### Busca R√°pida no INDEX.md
| Preciso... | Ver... |
|------------|--------|
| Setup novo projeto | setup-novo-projeto.md |
| M√≥dulo Artigos | modules/artigos/README.md |
| Email (PHPMailer) | QUICK_REFERENCE.md (linha ~451) |
| RD Station | QUICK_REFERENCE.md (linha ~475) |
| Changelog hoje | docs/CHANGELOG-2026-01-27.md |

---

## ‚úÖ CHECKLIST DE VALIDA√á√ÉO

- [x] M√≥dulo artigos instalado e funcionando
- [x] Email enviando com anexo PDF
- [x] RD Station recebendo leads
- [x] Admin settings salvando em _config.php
- [x] Valida√ß√µes completas implementadas
- [x] Testes manuais realizados
- [x] Logs limpos (sem debug)
- [x] Sintaxe PHP validada (php -l)
- [x] Documenta√ß√£o completa criada
- [x] Documenta√ß√£o principal atualizada

---

## üéì APRENDIZADOS

### UUID Migration Pattern
```php
// v9 (antigo)
$db->insert('tabela', [
    'titulo' => $titulo
    // id AUTO_INCREMENT autom√°tico
]);

// v14 (novo)
$id = Core::generateUUID();
$db->insert('tabela', [
    'id' => $id,
    'titulo' => $titulo
]);
```

### Config File Management
- Sempre fazer backup antes de modificar
- Suportar boolean, integer e string
- Escapar aspas internas em strings
- Adicionar no final se define n√£o existir

### Module v14 Format
- Remover `routes` (incompat√≠vel)
- Usar apenas `adminRoute` e `menu`
- `dependencies.core` lista classes necess√°rias
- `dependencies.tables` lista tabelas criadas
- `installation.schemas` aponta para SQLs

---

## üí° PR√ìXIMOS PASSOS (SUGERIDOS)

1. **Testar em novo projeto** - instalar AEGIS do zero e configurar tudo via admin
2. **Rate limiting** - adicionar em rotas p√∫blicas do m√≥dulo artigos
3. **Cache** - implementar cache na listagem de artigos
4. **Analytics** - dashboard com m√©tricas de leads capturados
5. **Email templates** - tornar templates customiz√°veis via admin

---

## üìû CONTEXTO PARA OUTRAS SESS√ïES

Se abrir nova janela Claude Code:

1. **Ler primeiro:** `.claude/INDEX.md`
2. **Estado atual:** `docs/_state.md`
3. **Changelog hoje:** `docs/CHANGELOG-2026-01-27.md`
4. **M√≥dulo artigos:** `modules/artigos/README.md`
5. **Setup novo:** `.claude/setup-novo-projeto.md`

**Comando:**
```
/aegis
```
J√° carrega contexto completo do framework.

---

**Sess√£o:** 27/01/2026
**Dura√ß√£o:** ~3h
**Status:** ‚úÖ Completo e documentado
**Pr√≥xima sess√£o:** Usar este arquivo como refer√™ncia

---

**Mantido por:** Claude Code
**Autor da sess√£o:** F√°bio Chezzi + Claude Code
