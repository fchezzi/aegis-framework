<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
	<meta charset="utf-8"/>
</head>
<body>

<h1 id="üîêsistemadepermiss√µesaegis">üîê Sistema de Permiss√µes AEGIS</h1>

<blockquote>
<p><strong>Quando usar este doc:</strong> Tarefas envolvendo MemberAuth, grupos, permiss√µes de acesso, ENABLE_MEMBERS</p>
</blockquote>

<blockquote>
<p><strong>Para Auth admin:</strong> Ver REGRAS.md #6 (Auth::require() obrigat√≥rio)</p>
</blockquote>

<hr />

<h2 id="üìävis√£ogeral:doissistemas">üìä Vis√£o Geral: Dois Sistemas</h2>

<table>
<colgroup>
<col />
<col />
<col />
<col />
<col />
</colgroup>

<thead>
<tr>
	<th> Tipo </th>
	<th> Classe </th>
	<th> Tabela </th>
	<th> Login </th>
	<th> Documenta√ß√£o </th>
</tr>
</thead>

<tbody>
<tr>
	<td> <strong>Admin</strong> </td>
	<td> <code>Auth</code> </td>
	<td> <code>users</code> </td>
	<td> <code>/admin/login</code> </td>
	<td> REGRAS.md #6 </td>
</tr>
<tr>
	<td> <strong>Member</strong> </td>
	<td> <code>MemberAuth</code> </td>
	<td> <code>members</code> </td>
	<td> <code>/login</code> </td>
	<td> Este documento </td>
</tr>
</tbody>
</table>

<p><strong>IMPORTANTE:</strong> <code>users</code> √© a tabela de admins (REGRAS.md #2)</p>

<hr />

<h2 id="üë•memberauthfrontendmembers">üë• MemberAuth (Frontend/Members)</h2>

<h3 id="apicompleta">API Completa</h3>

<pre><code class="php">MemberAuth::require();     // Exige login, redireciona para /login
MemberAuth::check();       // bool - est√° logado?
MemberAuth::member();      // ['id', 'email', 'name', 'group_id'] ou null
MemberAuth::login($email, $pass);
MemberAuth::logout();
</code></pre>

<h3 id="exemplo:p√°ginaprotegida">Exemplo: P√°gina Protegida</h3>

<pre><code class="php">// frontend/pages/dashboard.php
&lt;?php
MemberAuth::require();  // Bloqueia se n√£o estiver logado

$member = MemberAuth::member();
?&gt;
&lt;h1&gt;Bem-vindo, &lt;?= htmlspecialchars($member['name']) ?&gt;!&lt;/h1&gt;
</code></pre>

<h3 id="exemplo:controllerfrontend">Exemplo: Controller Frontend</h3>

<pre><code class="php">class ProfileController {
    public function edit() {
        MemberAuth::require();

        $member = MemberAuth::member();
        $memberId = $member['id'];

        // c√≥digo...
    }
}
</code></pre>

<hr />

<h2 id="üîësistemadepermiss√µesgranulares">üîë Sistema de Permiss√µes Granulares</h2>

<p><strong>Pr√©-requisito:</strong> <code>ENABLE_MEMBERS = true</code> em <code>_config.php</code></p>

<h3 id="apidepermiss√µes">API de Permiss√µes</h3>

<pre><code class="php">// Verifica√ß√£o
Permission::canAccess($memberId, $pageId);
Permission::getAccessiblePages($memberId);

// Conceder
Permission::grantIndividual($memberId, $pageId);
Permission::grantGroup($groupId, $pageId);

// Remover
Permission::removeIndividual($memberId, $pageId);
Permission::removeGroup($groupId, $pageId);
</code></pre>

<h3 id="ordemdepreced√™nciacr√çtico">Ordem de Preced√™ncia (CR√çTICO)</h3>

<p><strong>Verifica√ß√£o acontece NESTA ordem:</strong></p>

<ol>
<li>‚úÖ <strong>is_public = 1</strong> na tabela <code>pages</code> ‚Üí TODOS acessam</li>
<li>‚úÖ <strong>&#8220;public&#8221;: true</strong> em <code>module.json</code> ‚Üí TODOS acessam</li>
<li>‚ùå <strong>Member N√ÉO logado</strong> ‚Üí Bloqueia</li>
<li>‚úÖ <strong>Permiss√£o individual</strong> (<code>member_permissions</code>) ‚Üí Libera</li>
<li>‚úÖ <strong>Permiss√£o de grupo</strong> (<code>group_permissions</code>) ‚Üí Libera</li>
<li>‚ùå <strong>Nenhum match</strong> ‚Üí Bloqueia</li>
</ol>

<p><strong>Regra de ouro:</strong> P√∫blico &gt; Individual &gt; Grupo &gt; Bloquear</p>

<hr />

<h2 id="üéØgruposdepermiss√£o">üéØ Grupos de Permiss√£o</h2>

<h3 id="estruturadetabelas">Estrutura de Tabelas</h3>

<pre><code>groups (id, name, description)
  ‚îî‚îÄ members (id, email, group_id) FK
  ‚îî‚îÄ group_permissions (group_id, page_id)
</code></pre>

<h3 id="fluxocompleto:criargrupoeditores">Fluxo Completo: Criar Grupo &#8220;Editores&#8221;</h3>

<pre><code class="sql">-- 1. Criar grupo
INSERT INTO groups (id, name, description)
VALUES (Core::generateUUID(), 'Editores', 'Podem editar artigos');

-- 2. Conceder permiss√£o ao grupo
INSERT INTO group_permissions (group_id, page_id)
SELECT
    (SELECT id FROM groups WHERE name = 'Editores'),
    (SELECT id FROM pages WHERE slug = 'artigos');

-- 3. Adicionar member ao grupo
UPDATE members
SET group_id = (SELECT id FROM groups WHERE name = 'Editores')
WHERE email = 'editor@exemplo.com';
</code></pre>

<p><strong>Resultado:</strong> Todos members do grupo &#8220;Editores&#8221; acessam p√°gina &#8220;artigos&#8221;</p>

<h3 id="viaphpc√≥digo">Via PHP (C√≥digo)</h3>

<pre><code class="php">$db = DB::connect();

// 1. Criar grupo
$groupId = Core::generateUUID();
$db-&gt;insert('groups', [
    'id' =&gt; $groupId,
    'name' =&gt; 'Editores',
    'description' =&gt; 'Podem editar artigos'
]);

// 2. Conceder permiss√£o
$pageId = $db-&gt;select('pages', ['slug' =&gt; 'artigos'], 1)['id'];
Permission::grantGroup($groupId, $pageId);

// 3. Adicionar member
$db-&gt;update('members', ['group_id' =&gt; $groupId], ['email' =&gt; 'editor@exemplo.com']);
</code></pre>

<hr />

<h2 id="üåçp√°ginasp√∫blicasvsprivadas">üåç P√°ginas P√∫blicas vs Privadas</h2>

<h3 id="tornarp√∫blico2formas">Tornar P√∫blico (2 formas)</h3>

<p><strong>Forma 1: P√°gina est√°tica (tabela pages)</strong></p>

<pre><code class="sql">UPDATE pages SET is_public = 1 WHERE slug = 'sobre';
</code></pre>

<p><strong>Forma 2: M√≥dulo (module.json)</strong></p>

<pre><code class="json">{
  &quot;name&quot;: &quot;Blog&quot;,
  &quot;public&quot;: true
}
</code></pre>

<p><strong>REGRA #9:</strong> M√≥dulos ‚Üí <code>module.json</code>. P√°ginas ‚Üí tabela <code>pages</code>. NUNCA misturar.</p>

<hr />

<h2 id="üö´sistemasemmembersenable_membersfalse">üö´ Sistema SEM Members (ENABLE_MEMBERS = false)</h2>

<p><strong>Comportamento:</strong></p>

<pre><code class="php">define('ENABLE_MEMBERS', false);
</code></pre>

<ul>
<li>‚ùå <code>/login</code> n√£o funciona</li>
<li>‚úÖ TODO frontend √© p√∫blico automaticamente</li>
<li>‚úÖ MemberAuth::require() n√£o bloqueia nada</li>
<li>‚úÖ Apenas admins fazem login (<code>/admin</code>)</li>
<li>‚úÖ Funciona como site institucional</li>
</ul>

<p><strong>Quando usar:</strong> Sites corporativos, portf√≥lios, landing pages (sem √°rea de membros)</p>

<hr />

<h2 id="üîçintegra√ß√£ocommenubuilder">üîç Integra√ß√£o com MenuBuilder</h2>

<p><strong>MenuBuilder.php verifica automaticamente:</strong></p>

<pre><code class="php">// Pseudoc√≥digo
if ($page['is_public'] == 1) {
    return true;  // Mostrar para todos
}

if ($module['public'] == true) {
    return true;  // Mostrar para todos
}

if (!MemberAuth::check()) {
    return false;  // Esconder se n√£o logado
}

if (Permission::canAccess($memberId, $pageId)) {
    return true;  // Verificou permiss√£o
}

return false;  // Bloquear
</code></pre>

<p><strong>Resultado:</strong> Menu se adapta automaticamente ao contexto do usu√°rio</p>

<hr />

<h2 id="üõ†Ô∏ètroubleshooting">üõ†Ô∏è Troubleshooting</h2>

<h3 id="membertempermiss√£omasn√£oacessa">&#8220;Member tem permiss√£o mas n√£o acessa&#8221;</h3>

<pre><code class="php">// Debug checklist
var_dump(MemberAuth::check());  // true?
var_dump(MemberAuth::member()['id']);  // UUID correto?

$db = DB::connect();
$perm = $db-&gt;select('member_permissions', [
    'member_id' =&gt; $memberId,
    'page_id' =&gt; $pageId
]);
var_dump($perm);  // array n√£o vazio?
</code></pre>

<h3 id="enable_membersfalsemaspedelogin">&#8220;ENABLE_MEMBERS = false mas pede login&#8221;</h3>

<p><strong>Causa:</strong> <code>MemberAuth::require()</code> hardcoded em p√°gina que deveria ser p√∫blica</p>

<p><strong>Solu√ß√£o:</strong> Remover <code>MemberAuth::require()</code> dessa p√°gina</p>

<hr />

<h2 id="üìãchecklistdeuso">üìã Checklist de Uso</h2>

<p><strong>Criar sistema de permiss√µes:</strong></p>

<pre><code>‚ñ° Verificar ENABLE_MEMBERS = true em _config.php
‚ñ° Criar grupos via SQL ou painel admin
‚ñ° Atribuir members aos grupos (UPDATE members SET group_id)
‚ñ° Conceder permiss√µes (Permission::grantGroup ou SQL)
</code></pre>

<p><strong>Proteger p√°gina frontend:</strong></p>

<pre><code>‚ñ° Adicionar MemberAuth::require() no topo da p√°gina
‚ñ° OU configurar permiss√£o via grupo/individual
</code></pre>

<p><strong>Tornar conte√∫do p√∫blico:</strong></p>

<pre><code>‚ñ° P√°ginas: UPDATE pages SET is_public = 1
‚ñ° M√≥dulos: &quot;public&quot;: true em module.json
</code></pre>

<hr />

<h2 id="üìörefer√™nciascruzadas">üìö Refer√™ncias Cruzadas</h2>

<ul>
<li><strong>Auth admin:</strong> REGRAS.md #6</li>
<li><strong>M√≥dulos vs P√°ginas:</strong> REGRAS.md #9</li>
<li><strong>Tabela users (n√£o admins):</strong> REGRAS.md #2</li>
<li><strong>P√°ginas p√∫blicas no menu:</strong> known-issues.md #3</li>
</ul>

<hr />

<p><strong>Vers√£o:</strong> 3.0.0
<strong>Data:</strong> 2026&#8211;02&#8211;14
<strong>Changelog:</strong> Removidas redund√¢ncias com REGRAS.md e known-issues.md, focado em MemberAuth e sistema de permiss√µes granulares</p>

</body>
</html>

