<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
	<meta charset="utf-8"/>
</head>
<body>

<h1 id="üì§guiacompleto:uploaddearquivos">üì§ Guia Completo: Upload de Arquivos</h1>

<blockquote>
<p><strong>Quando usar:</strong> Qualquer implementa√ß√£o de upload (CRUD, TinyMCE, standalone). Upload √© vetor de ataque #1 - seguir TODOS os passos de seguran√ßa.</p>
</blockquote>

<hr />

<h2 id="üéØcen√°riosdeupload">üéØ Cen√°rios de Upload</h2>

<table>
<colgroup>
<col />
<col />
<col />
</colgroup>

<thead>
<tr>
	<th> Cen√°rio </th>
	<th> Uso </th>
	<th> Refer√™ncia </th>
</tr>
</thead>

<tbody>
<tr>
	<td> <strong>CRUD Admin</strong> </td>
	<td> Foto de produto, imagem destaque, banner </td>
	<td> Se√ß√£o 1 </td>
</tr>
<tr>
	<td> <strong>TinyMCE</strong> </td>
	<td> Upload inline no editor rico </td>
	<td> Se√ß√£o 2 </td>
</tr>
<tr>
	<td> <strong>Standalone</strong> </td>
	<td> M√∫ltiplos arquivos, CSV, galeria </td>
	<td> Se√ß√£o 3 </td>
</tr>
</tbody>
</table>

<hr />

<h2 id="üìãantesdecome√ßar">üìã Antes de Come√ßar</h2>

<p><strong>Decis√µes obrigat√≥rias:</strong></p>

<ul>
<li>[ ] Que tipo de arquivo? (imagem, PDF, CSV, etc)</li>
<li>[ ] Tamanho m√°ximo? (5MB imagem, 10MB docs)</li>
<li>[ ] Onde armazenar? (<code>storage/uploads/{tipo}/</code>)</li>
<li>[ ] P√∫blico ou privado?</li>
</ul>

<hr />

<h2 id="1Ô∏è‚É£cen√Årio1:uploademcrudadmin">1Ô∏è‚É£ CEN√ÅRIO 1: Upload em CRUD Admin</h2>

<p><strong>Exemplo:</strong> Produto com foto, Post com imagem destaque</p>

<h3 id="controllerpattern:">Controller Pattern:</h3>

<pre><code class="php">public function store() {
    Auth::require();
    Security::validateCSRF($_POST['csrf_token']);

    $db = DB::connect();
    $errors = [];

    // Campos normais
    $nome = Security::sanitize($_POST['nome'] ?? '');
    if (empty($nome)) $errors[] = 'Nome obrigat√≥rio';

    // ‚úÖ UPLOAD DE IMAGEM
    $imagemPath = null;
    if (!empty($_FILES['imagem']['tmp_name'])) {
        $upload = Upload::image($_FILES['imagem'], 'produtos');

        if ($upload['success']) {
            $imagemPath = $upload['path'];
        } else {
            $errors[] = $upload['message']; // ‚ö†Ô∏è 'message' n√£o 'error'
        }
    }

    if (!empty($errors)) {
        $_SESSION['error'] = implode('&lt;br&gt;', $errors);
        Core::redirect('/admin/produtos/create');
    }

    // Insert
    $db-&gt;insert('produtos', [
        'id' =&gt; Core::generateUUID(),
        'nome' =&gt; $nome,
        'imagem' =&gt; $imagemPath,
        'ativo' =&gt; isset($_POST['ativo']) ? 1 : 0
    ]);

    $_SESSION['success'] = 'Criado!';
    Core::redirect('/admin/produtos');
}
</code></pre>

<h3 id="updatecomtrocadeimagem:">Update com Troca de Imagem:</h3>

<pre><code class="php">public function update($id) {
    Auth::require();
    Security::validateCSRF($_POST['csrf_token']);

    $db = DB::connect();

    // Buscar item atual
    $item = $db-&gt;query(&quot;SELECT * FROM produtos WHERE id = ?&quot;, [$id])[0];

    // ‚úÖ MANTER IMAGEM ATUAL OU TROCAR
    $imagemPath = $item['imagem']; // Manter atual

    if (!empty($_FILES['imagem']['tmp_name'])) {
        $upload = Upload::image($_FILES['imagem'], 'produtos');

        if ($upload['success']) {
            // Deletar antiga
            if (!empty($imagemPath)) {
                Upload::delete($imagemPath); // ‚ö†Ô∏è Upload::delete (n√£o unlink)
            }

            $imagemPath = $upload['path'];
        } else {
            $_SESSION['error'] = $upload['message'];
            Core::redirect('/admin/produtos/edit/' . $id);
        }
    }

    // Update
    $db-&gt;update('produtos', [
        'nome' =&gt; Security::sanitize($_POST['nome']),
        'imagem' =&gt; $imagemPath
    ], ['id' =&gt; $id]);

    $_SESSION['success'] = 'Atualizado!';
    Core::redirect('/admin/produtos');
}
</code></pre>

<h3 id="deletecomremo√ß√£odearquivo:">Delete com Remo√ß√£o de Arquivo:</h3>

<pre><code class="php">public function delete($id) {
    Auth::require();
    Security::validateCSRF($_POST['csrf_token']);

    $db = DB::connect();
    $item = $db-&gt;query(&quot;SELECT * FROM produtos WHERE id = ?&quot;, [$id])[0];

    // ‚úÖ DELETAR ARQUIVO
    if (!empty($item['imagem'])) {
        Upload::delete($item['imagem']);
    }

    $db-&gt;delete('produtos', ['id' =&gt; $id]);

    $_SESSION['success'] = 'Deletado!';
    Core::redirect('/admin/produtos');
}
</code></pre>

<h3 id="viewform:">View (Form):</h3>

<pre><code class="php">&lt;form method=&quot;POST&quot; action=&quot;&lt;?= url('/admin/produtos/store') ?&gt;&quot; enctype=&quot;multipart/form-data&quot;&gt;
    &lt;input type=&quot;hidden&quot; name=&quot;csrf_token&quot; value=&quot;&lt;?= Security::generateCSRF() ?&gt;&quot;&gt;

    &lt;div class=&quot;form-group&quot;&gt;
        &lt;label for=&quot;nome&quot;&gt;Nome *&lt;/label&gt;
        &lt;input type=&quot;text&quot; id=&quot;nome&quot; name=&quot;nome&quot; required&gt;
    &lt;/div&gt;

    &lt;div class=&quot;form-group&quot;&gt;
        &lt;label for=&quot;imagem&quot;&gt;Imagem&lt;/label&gt;

        &lt;!-- Preview imagem atual (edit) --&gt;
        &lt;?php if (!empty($produto['imagem'])): ?&gt;
            &lt;div class=&quot;current-image&quot;&gt;
                &lt;img src=&quot;&lt;?= Upload::url($produto['imagem']) ?&gt;&quot;
                     alt=&quot;Atual&quot;
                     style=&quot;max-width: 200px;&quot;&gt;
                &lt;p&gt;&lt;small&gt;Imagem atual&lt;/small&gt;&lt;/p&gt;
            &lt;/div&gt;
        &lt;?php endif; ?&gt;

        &lt;input type=&quot;file&quot; id=&quot;imagem&quot; name=&quot;imagem&quot; accept=&quot;image/jpeg,image/png,image/webp&quot;&gt;
        &lt;small&gt;JPG, PNG ou WEBP (m√°x 5MB)&lt;/small&gt;
    &lt;/div&gt;

    &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary&quot;&gt;Salvar&lt;/button&gt;
&lt;/form&gt;
</code></pre>

<hr />

<h2 id="2Ô∏è‚É£cen√Årio2:uploadnotinymceeditor">2Ô∏è‚É£ CEN√ÅRIO 2: Upload no TinyMCE (Editor)</h2>

<p><strong>Uso:</strong> Upload de imagens inline no conte√∫do rico</p>

<h3 id="configem_config.php:">Config em _config.php:</h3>

<pre><code class="php">define('TINYMCE_API_KEY', 'sua-chave-aqui');
</code></pre>

<h3 id="viewcomtinymce:">View com TinyMCE:</h3>

<pre><code class="php">&lt;textarea id=&quot;conteudo&quot; name=&quot;conteudo&quot;&gt;&lt;/textarea&gt;

&lt;script src=&quot;https://cdn.tiny.cloud/1/&lt;?= TINYMCE_API_KEY ?&gt;/tinymce/6/tinymce.min.js&quot;&gt;&lt;/script&gt;
&lt;script&gt;
tinymce.init({
    selector: '#conteudo',
    height: 500,
    language: 'pt_BR',
    plugins: ['advlist', 'autolink', 'lists', 'link', 'image', 'media', 'table', 'code'],
    toolbar: 'undo redo | blocks | bold italic | link image media',

    // ‚úÖ Upload de imagens
    images_upload_url: '&lt;?= url('/admin/blog/upload-image') ?&gt;',
    automatic_uploads: true,

    // YouTube embed
    media_live_embeds: true
});
&lt;/script&gt;
</code></pre>

<h3 id="controllerupload:">Controller Upload:</h3>

<pre><code class="php">public function uploadImage() {
    Auth::require();
    header('Content-Type: application/json');

    $upload = Upload::image($_FILES['file'], 'blog');

    if ($upload['success']) {
        echo json_encode([
            'location' =&gt; url('/storage/uploads/' . $upload['path'])
        ]);
    } else {
        echo json_encode([
            'error' =&gt; $upload['message']
        ]);
    }
    exit;
}
</code></pre>

<h3 id="route:">Route:</h3>

<pre><code class="php">Router::post('/admin/blog/upload-image', function() {
    $controller = new AdminBlogController();
    $controller-&gt;uploadImage();
});
</code></pre>

<h3 id="databaseconte√∫dorico:">Database (conte√∫do rico):</h3>

<pre><code class="sql">-- Para conte√∫do com imagens/v√≠deos embedados
conteudo MEDIUMTEXT NOT NULL  -- 16MB (n√£o TEXT 64KB)
</code></pre>

<hr />

<h2 id="3Ô∏è‚É£cen√Årio3:uploadstandaloneavan√ßado">3Ô∏è‚É£ CEN√ÅRIO 3: Upload Standalone (Avan√ßado)</h2>

<p><strong>Uso:</strong> M√∫ltiplos arquivos, importa√ß√£o CSV, galeria de imagens</p>

<h3 id="m√∫ltiplosarquivos:">M√∫ltiplos Arquivos:</h3>

<pre><code class="php">public function uploadMultiple() {
    Auth::require();
    Security::validateCSRF($_POST['csrf_token']);

    $db = DB::connect();
    $uploadedPaths = [];
    $errors = [];

    // $_FILES['imagens'] √© array quando input tem multiple
    $files = $_FILES['imagens'];
    $totalFiles = count($files['name']);

    for ($i = 0; $i &lt; $totalFiles; $i++) {
        // Montar array compat√≠vel com Upload::image()
        $file = [
            'name' =&gt; $files['name'][$i],
            'type' =&gt; $files['type'][$i],
            'tmp_name' =&gt; $files['tmp_name'][$i],
            'error' =&gt; $files['error'][$i],
            'size' =&gt; $files['size'][$i]
        ];

        // Upload individual
        $upload = Upload::image($file, 'galeria');

        if ($upload['success']) {
            $uploadedPaths[] = $upload['path'];

            // Salvar no banco (opcional)
            $db-&gt;insert('galeria_imagens', [
                'id' =&gt; Core::generateUUID(),
                'path' =&gt; $upload['path'],
                'ordem' =&gt; $i
            ]);
        } else {
            $errors[] = &quot;Arquivo {$file['name']}: {$upload['message']}&quot;;
        }
    }

    if (!empty($errors)) {
        $_SESSION['error'] = implode('&lt;br&gt;', $errors);
    } else {
        $_SESSION['success'] = count($uploadedPaths) . ' imagens enviadas!';
    }

    Core::redirect('/admin/galeria');
}
</code></pre>

<h3 id="formm√∫ltiplosarquivos:">Form M√∫ltiplos Arquivos:</h3>

<pre><code class="php">&lt;form method=&quot;POST&quot; action=&quot;&lt;?= url('/admin/galeria/upload') ?&gt;&quot; enctype=&quot;multipart/form-data&quot;&gt;
    &lt;input type=&quot;hidden&quot; name=&quot;csrf_token&quot; value=&quot;&lt;?= Security::generateCSRF() ?&gt;&quot;&gt;

    &lt;div class=&quot;form-group&quot;&gt;
        &lt;label for=&quot;imagens&quot;&gt;Selecionar Imagens&lt;/label&gt;
        &lt;input type=&quot;file&quot;
               id=&quot;imagens&quot;
               name=&quot;imagens[]&quot;
               multiple
               accept=&quot;image/*&quot;
               required&gt;
        &lt;small&gt;Selecione m√∫ltiplas imagens (Ctrl/Cmd + clique)&lt;/small&gt;
    &lt;/div&gt;

    &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary&quot;&gt;Upload&lt;/button&gt;
&lt;/form&gt;
</code></pre>

<h3 id="importa√ß√£odecsv:">Importa√ß√£o de CSV:</h3>

<pre><code class="php">public function importCSV() {
    Auth::require();
    Security::validateCSRF($_POST['csrf_token']);

    if (empty($_FILES['csv']['tmp_name'])) {
        $_SESSION['error'] = 'Nenhum arquivo enviado';
        Core::redirect('/admin/produtos/import');
    }

    $file = $_FILES['csv'];

    // ‚úÖ Validar tipo
    $finfo = finfo_open(FILEINFO_MIME_TYPE);
    $mime = finfo_file($finfo, $file['tmp_name']);
    finfo_close($finfo);

    if (!in_array($mime, ['text/plain', 'text/csv', 'application/csv'])) {
        $_SESSION['error'] = 'Arquivo deve ser CSV';
        Core::redirect('/admin/produtos/import');
    }

    // ‚úÖ Processar CSV
    $handle = fopen($file['tmp_name'], 'r');
    $header = fgetcsv($handle); // Primeira linha = cabe√ßalho
    $imported = 0;
    $db = DB::connect();

    while (($row = fgetcsv($handle)) !== false) {
        // Mapear colunas
        $nome = $row[0] ?? '';
        $preco = $row[1] ?? 0;

        if (empty($nome)) continue;

        $db-&gt;insert('produtos', [
            'id' =&gt; Core::generateUUID(),
            'nome' =&gt; Security::sanitize($nome),
            'preco' =&gt; floatval($preco),
            'ativo' =&gt; 1
        ]);

        $imported++;
    }

    fclose($handle);

    $_SESSION['success'] = &quot;{$imported} produtos importados!&quot;;
    Core::redirect('/admin/produtos');
}
</code></pre>

<hr />

<h2 id="üõ°Ô∏èuploadclass-apicompleta">üõ°Ô∏è Upload Class - API Completa</h2>

<h3 id="upload::image">Upload::image()</h3>

<pre><code class="php">$result = Upload::image($_FILES['foto'], 'produtos', [
    'maxSize' =&gt; 5242880,  // 5MB (opcional, padr√£o 5MB)
    'allowedTypes' =&gt; ['image/jpeg', 'image/png', 'image/webp']  // Opcional
]);

if ($result['success']) {
    $path = $result['path'];  // ‚ö†Ô∏è 'path' n√£o 'file'
} else {
    $erro = $result['message'];  // ‚ö†Ô∏è 'message' n√£o 'error'
}
</code></pre>

<p><strong>Valida√ß√µes autom√°ticas:</strong></p>

<ol>
<li>MIME type real (finfo, n√£o extens√£o)</li>
<li>Extens√£o permitida baseada no MIME</li>
<li>Tamanho m√°ximo</li>
<li>Dimens√µes (para imagens)</li>
<li>Nome sanitizado (gerado aleatoriamente)</li>
<li>Path traversal bloqueado</li>
<li>Permiss√µes corretas (0644)</li>
</ol>

<h3 id="upload::delete">Upload::delete()</h3>

<pre><code class="php">Upload::delete($path);  // ‚ö†Ô∏è N√ÉO usar unlink() diretamente
</code></pre>

<h3 id="upload::url">Upload::url()</h3>

<pre><code class="php">&lt;img src=&quot;&lt;?= Upload::url($produto['imagem']) ?&gt;&quot; alt=&quot;Produto&quot;&gt;
</code></pre>

<p>Retorna: <code>/storage/uploads/produtos/2025/02/1739557234_a3f4d5e6.jpg</code></p>

<hr />

<h2 id="üîêchecklistdeseguran√ßaobrigat√ìrio">üîê Checklist de Seguran√ßa OBRIGAT√ìRIO</h2>

<pre><code>‚úÖ MIME validation (finfo, n√£o $_FILES['type'])
‚úÖ Extens√£o validada baseada no MIME
‚úÖ Tamanho m√°ximo definido
‚úÖ Nome sanitizado (aleat√≥rio, nunca original)
‚úÖ CSRF token validado
‚úÖ Auth::require() no controller
‚úÖ Upload::delete() ao remover (n√£o unlink)
‚úÖ Storage fora do webroot OU .htaccess bloqueando execu√ß√£o
</code></pre>

<h3 id=".htaccessnostoragecr√çtico:">.htaccess no Storage (CR√çTICO):</h3>

<p>Criar <code>storage/uploads/.htaccess</code>:</p>

<pre><code class="apache"># ‚úÖ BLOQUEAR EXECU√á√ÉO DE SCRIPTS
&lt;FilesMatch &quot;\.(php|phtml|php3|php4|php5|pl|py|jsp|asp|html|shtml|sh|cgi)$&quot;&gt;
    Require all denied
&lt;/FilesMatch&gt;

# ‚úÖ PERMITIR APENAS ARQUIVOS ESPEC√çFICOS
&lt;FilesMatch &quot;\.(jpg|jpeg|png|gif|webp|pdf|doc|docx|xls|xlsx|txt|csv)$&quot;&gt;
    Require all granted
&lt;/FilesMatch&gt;
</code></pre>

<hr />

<h2 id="‚ö†Ô∏èerroscomuns">‚ö†Ô∏è Erros Comuns</h2>

<h3 id="‚ùåerrado:">‚ùå ERRADO:</h3>

<pre><code class="php">// 1. Confundir keys do resultado
$path = $result['file'];  // ‚ùå N√£o existe
$erro = $result['error'];  // ‚ùå N√£o existe

// 2. Usar unlink direto
unlink(UPLOAD_PATH . $path);  // ‚ùå Path incorreto, sem valida√ß√£o

// 3. Confiar na extens√£o
if ($_FILES['file']['type'] == 'image/jpeg') {  // ‚ùå Pode ser forjado

// 4. Nome original
$filename = $_FILES['file']['name'];  // ‚ùå Risco de path traversal
move_uploaded_file($tmp, &quot;uploads/&quot; . $filename);
</code></pre>

<h3 id="‚úÖcerto:">‚úÖ CERTO:</h3>

<pre><code class="php">// 1. Keys corretas
$path = $result['path'];
$erro = $result['message'];

// 2. Upload::delete()
Upload::delete($path);

// 3. MIME real
$upload = Upload::image($_FILES['file'], 'tipo');  // Valida MIME interno

// 4. Nome sanitizado
// Upload::image() gera nome aleat√≥rio automaticamente
</code></pre>

<hr />

<h2 id="üìörefer√™ncias">üìö Refer√™ncias</h2>

<ul>
<li><strong>CRUD com upload:</strong> module-patterns.md (Controller Pattern)</li>
<li><strong>Valida√ß√£o de inputs:</strong> REGRAS.md #6</li>
<li><strong>CSRF obrigat√≥rio:</strong> REGRAS.md #5</li>
<li><strong>Upload valida√ß√µes:</strong> REGRAS.md #9</li>
</ul>

<hr />

<p><strong>Vers√£o:</strong> 2.0.0
<strong>Data:</strong> 2026&#8211;02&#8211;14
<strong>Changelog:</strong> Refatorado de implementa√ß√£o ‚Üí guia de uso. Focado em 3 cen√°rios (CRUD, TinyMCE, standalone). Reduzido de 531 ‚Üí 318 linhas.</p>

</body>
</html>

